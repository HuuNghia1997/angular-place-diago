<!--  Title  -->
<mat-toolbar class="title">
  <mat-toolbar-row>
    <h6 class="name-page">Chi tiết phản ánh</h6>
  </mat-toolbar-row>
</mat-toolbar>

<div class="container">
  <mat-card>
    <mat-card-title>
      <button [ngClass]="selectStyleStatus(status)">
        {{ statusDescription }}
      </button>
      {{ title }}
    </mat-card-title>

    <div class="button-action">
      <!-- Btn cập nhật -->
      <button mat-button *ngIf='status === 3' class="fs-13" (click)="updatePetition(petitionId, title)">
        <mat-icon fontSet="material-icons-outlined"> create </mat-icon>
        Cập nhật
      </button>

      <!-- Btn tiếp nhận -->
      <button *ngIf='status === 2' mat-button class="ml-1 fs-13" (click)="showProcess(processInstanceId, title)">
        <mat-icon fontSet="material-icons-outlined"> timeline </mat-icon>
        Xem quy trình
      </button>
    </div>
    <!-- div button-action -->

    <table class="table-content">
      <tr>
        <td class="col-1-content">
          <!-- Thông tin phản ánh -->
          <h4>Thông tin phản ánh</h4>
          <table class="table-info-petition">
            <tr>
              <td class="td-1">Chuyên mục:</td>
              <td class="td-2">{{ tagName }}</td>
            </tr>
            <tr>
              <td class="td-1">Thời gian xảy ra:</td>
              <td class="td-2">
                {{ takePlaceOn | date: "dd/MM/yyyy HH:mm:ss" }}
              </td>
            </tr>
            <tr>
              <td class="td-1">Ngày phản ánh:</td>
              <td class="td-2">
                {{ createdDate | date: "dd/MM/yyyy HH:mm:ss" }}
              </td>
            </tr>
            <tr>
              <td class="td-1">Người gửi:</td>
              <td class="td-2">{{ reporterFullname }}</td>
            </tr>
            <tr>
              <td class="td-1">Nơi tạo phản ánh:</td>
              <td class="td-2">
                {{ takePlaceAtFullAddress }} (
                <button class="btn-map">
                  <mat-icon fontSet="material-icons-outlined" class="icon-map">
                    place
                  </mat-icon>
                  Xem bản đồ
                </button>)
              </td>
            </tr>
            <tr>
              <td class="td-1">Địa điểm phản ánh:</td>
              <td>
                {{ takePlaceAtFullAddress }} (
                <button class="btn-map">
                  <mat-icon fontSet="material-icons-outlined" class="icon-map">
                    place
                  </mat-icon>
                  Xem bản đồ
                </button>)
              </td>
            </tr>
          </table>
          <!-- Thông tin phản ánh -->

          <!-- Nội dung phản ánh -->
          <h4 class="mt-2">Nội dung</h4>
          <table class="table-content-petition">
            <tr>
              {{
                  description
                }}
            </tr>
          </table>
          <!-- Nội dung phản ánh -->

          <!-- File đính kèm -->
          <!-- Hình ảnh -->
          <div class="mt-2">
            <h4 id="title">Hình ảnh</h4>
            <div [ngClass]="{ img_uploaded: uploaded == true }">
              <div class="drag_upload_btn" [ngClass]="{ no_boder: uploaded == true }"></div>
              <div *ngIf="checkFiles; then thenBlock; else elseBlock"></div>
              <ng-template #thenBlock>
                <div class="image_drag_upload_preview">
                  <div class="list_uploaded" *ngFor="let file of filesInfo">
                    <div class="img_items mat-elevation-z4" [ngStyle]="{
                          'background-image': 'url(' + file.url + ')'
                        }"></div>
                    <div class="img_control">
                      <span class="file_name" matTooltip="{{ file.fullName }}" [matTooltipPosition]="'right'">
                        {{ file.name }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-template>
              <ng-template #elseBlock>
                <div class="center mb-3">
                  Không có hình ảnh nào
                </div>
              </ng-template>
            </div>
          </div>

          <!-- Lịch sử - hoạt động -->
          <h4 class="mt-2">Hoạt động</h4>
          <mat-tab-group>
            <!-- Bình luận -->
            <mat-tab label="Bình luận">
              <mat-tree [dataSource]="commentDataSource" [treeControl]="treeControl" class="tree">
                <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
                  {{ node.name }}
                </mat-tree-node>
                <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
                  <div class="mat-tree-node">
                    <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'toggle ' + node.name"
                      style="border: none;">
                      <mat-icon class="mat-icon-rtl-mirror">
                        {{
                            treeControl.isExpanded(node)
                              ? "expand_more"
                              : "chevron_right"
                          }}
                      </mat-icon>
                    </button>
                    <span class="name-user"> {{ node.name }} </span>
                    <span class="action">
                      &nbsp;đã bình luận -
                      {{ node.time | date: "dd/MM/yyyy HH:mm:ss" }}
                    </span>
                  </div>
                  <ul [class.tree-invisible]="treeControl.isExpanded(node)">
                    <ng-container matTreeNodeOutlet></ng-container>
                  </ul>
                  <mat-divider></mat-divider>
                </mat-nested-tree-node>
              </mat-tree>

              <button mat-button class="mt-10" (click)="openCommentDialog(petitionId, title)">
                <mat-icon fontSet="material-icons-outlined">
                  insert_comment
                </mat-icon>
                Bình luận
              </button>
            </mat-tab>
            <!-- Bình luận -->

            <!-- Lịch sử -->
            <mat-tab label="Lịch sử">
              <mat-card class="card-history" *ngFor="let his of history">
                <mat-card-subtitle>
                  <span class="name-user"> {{ his.user.name }} </span>
                  <span class="action">
                    &nbsp;đã
                    <ng-container *ngFor="let item of historyTypeList">
                      <ng-container *ngIf="item.id === his.type">
                        {{ item.name }} -
                      </ng-container>
                    </ng-container>
                    {{ his.affectedDate | date: "dd/MM/yyyy HH:mm:ss" }}
                  </span>
                  <ng-container *ngIf="his.action.length > 0">
                    <div class="history_content mt-1" [ngClass]="{ 'd-none': his.type === 4 }">
                      <div style="width: 20%;">
                        <b> Trường </b>
                      </div>
                      <div style="width: 30%;">
                        <b> Giá trị cũ </b>
                      </div>
                      <div style="width: 30%;">
                        <b> Giá trị mới </b>
                      </div>
                    </div>
                    <div class="history_content mt-1" *ngFor="let his_item of his.action"
                      [ngClass]="{ 'd-none': his.type === 4 }">
                      <div style="width: 20%;">
                        <p>{{ his_item.fieldName }}</p>
                      </div>
                      <div style="width: 30%;">
                        <p>{{ his_item.originalValue }}</p>
                      </div>
                      <div style="width: 30%;">
                        <p>{{ his_item.newValue }}</p>
                      </div>
                    </div>
                  </ng-container>
                </mat-card-subtitle>
              </mat-card>
            </mat-tab>
            <!-- Lịch sử -->
          </mat-tab-group>
          <!-- Lịch sử - hoạt động -->
        </td>
        <!-- col-1-content -->

        <td class="col-2-content"></td>
        <!-- col-2-content -->

        <td class="col-3-content">
          <!-- Thông tin xử lý -->
          <h4>Thông tin người phản ánh</h4>
          <table class="table-info-process">
            <tr>
              <td class="td-1 width-40">Người gửi:</td>
              <td class="td-2 width-60">{{ reporterFullname }}</td>
            </tr>
            <tr>
              <td class="td-1 width-40">Số điện thoại:</td>
              <td class="td-2 width-60">{{ reporterPhone }}</td>
            </tr>
            <tr>
              <td class="td-1 width-40">CMND</td>
              <td class="td-2 width-60">{{ reporterIdentityId }}</td>
            </tr>
            <tr>
              <td class="td-1 width-40">Đối tượng</td>
              <td class="td-2 width-60"> {{ reporterType }} </td>
            </tr>
            <tr>
              <td class="td-1 width-40">Địa chỉ</td>
              <td class="td-2 width-60">
                {{ reporterAddress }}
              </td>
            </tr>
          </table>
          <!-- Kết quả xử lý -->
          <div *ngIf='hasResult'>
            <h4 class="mt-2"> Thông tin kết quả </h4>
            <table class="table-result">
              <tr>
                <td class="td-1 width-40"> Ngày có kết quả: </td>
                <td class="td-2 width-60"> {{ resultDate | date: "dd/MM/yyyy HH:mm:ss" }} </td>
              </tr>
              <tr>
                <td class="td-1 width-40"> Công khai: </td>
                <td class="td-2 width-60">
                  <button [ngClass]="resultIsPublic ? 'btn-receive' : 'btn-none-public'">
                    {{resultIsPublicDescription}}
                  </button>
                </td>
              </tr>
              <tr class="td-1 width-40"> Nội dung: </tr>
              <tr class="td-2 width-60">
                <span [class.overflow]="isExpand" [ngClass]="(isExpand === true ? 'overflow' : 'show-content')">
                  {{resultContent}}
                </span>
                <a [ngClass]="(isExpand === true ? 'see-more' : 'hidden-see-more')" (click)="isExpandToggle()"> Xem thêm </a>
                <a [ngClass]="(isExpand === false ? 'see-more' : 'hidden-see-more')" (click)="isExpandToggle()"> Thu gọn </a>
              </tr>
            </table> <!-- Kết quả xử lý -->

            <!-- <div [ngClass]="resultPetition === undefined ? 'd-none' : 'img_uploaded'">
              <div class="image_drag_upload_preview">
                <div class="list_uploaded_result" *ngFor="let file of filesResult">
                  <div class="img_items mat-elevation-z4" [ngStyle]="{'background-image': 'url('+ file.url +')'}"></div>
                  <div class="img_control">
                    <span class="file_name" matTooltip="{{ file.fullName }}" [matTooltipPosition]="'right'"> {{ file.name }} </span>
                    <a mat-icon-button class="delete_img" download="{{ file.name }}" href="{{ file.url }}">
                      <mat-icon class="icon"> save_alt </mat-icon>
                    </a>
                  </div>
                </div>
              </div>
            </div> -->
          
            <div [ngClass]="resultPetition === undefined || filesInfo.length === 0 ? 'd-none' : 'img_uploaded'">
              <div class="image_drag_upload_preview">
                <div class="list_uploaded" *ngFor="let file of filesInfo">
                  <div class="img_items mat-elevation-z4" [ngStyle]="{'background-image': 'url('+ file.url +')'}"></div>
                  <div class="img_control">
                    <span class="file_name" matTooltip="{{ file.fullName }}" [matTooltipPosition]="'right'"> {{ file.name }} </span>
                    <a mat-icon-button class="delete_img" download="{{ file.name }}" href="{{ file.url }}">
                      <mat-icon class="icon"> save_alt </mat-icon>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
        <!-- col-3-content -->
      </tr>
    </table>
    <!-- table content -->
  </mat-card>
</div>
<!-- div container -->